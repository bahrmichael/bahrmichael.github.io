---
layout: default
title: Spending
---

        <form> 
            <style scoped>@import url('https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css');</style>
       
            <div class="form-group">
                <label for="lambdaSaving">Lambda savings</label>
                <div class="input-group mb-3" id="lambdaWrapper">
                    <input style="max-width: 100px;" type="number" class="form-control" id="lambdaSaving" aria-describedby="lambdaInputDescription" placeholder="12" onchange="redraw()">
                    <div class="input-group-append">
                      <span class="input-group-text" id="lambdaInputDescription">% over on-demand</span>
                    </div>
                </div>
                <small id="lambdaWrapper" class="form-text text-muted">Please get your savings rate from the <a href="https://aws.amazon.com/savingsplans/pricing/" target="_blank">Savings Plan page</a>. 12% is 1 year with no upfront payment in us-east-1.</small>
            </div>
            <div class="form-group">
                <label for="ec2Saving">EC2 savings</label>
                <div class="input-group mb-3" id="ec2Wrapper">
                    <input type="number" class="form-control" id="ec2Saving" aria-describedby="ec2InputDescription" placeholder="28" onchange="redraw()">
                    <div class="input-group-append">
                      <span class="input-group-text" id="ec2InputDescription">% over on-demand</span>
                    </div>
                </div>
                <small id="ec2Wrapper" class="form-text text-muted">Please get the savings rate from the <a href="https://aws.amazon.com/savingsplans/pricing/" target="_blank">Savings Plan page</a>. 28% is a Linux t2.micro, 1 year with no upfront in us-east-1.</small>
            </div>
            <div class="form-group">
                <label for="hourlyCommitment">Hourly Commitment</label>
                <div class="input-group mb-3" id="hourlyCommitmentWrapper">
                    <input style="max-width: 100px;" type="number" class="form-control" id="hourlyCommitment" aria-describedby="hourlyCommitmentDescription" placeholder="0.03" onchange="redraw()">
                    <div class="input-group-append">
                      <span class="input-group-text" id="hourlyCommitmentDescription">$ per hour</span>
                    </div>
                </div>
                <small id="hourlyCommitmentWrapper" class="form-text text-muted">
                    <span id="calculatedCommitment" style="display: none;">Monthly commitment: $<span id="monthlyCommitment"></span><br/>Yearly commitment: $<span id="yearlyCommitment"></span></span>
                </small>
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="inputGroupFileAddon01">Upload</span>
                </div>
                <div class="custom-file">
                    <input style="max-width: 400px;" type="file" class="custom-file-input" id="csvFileUpload" name="CSV Upload" aria-describedby="inputGroupFileAddon01" accept=".csv" onchange="uploadFile(this.files[0]);">
                    <label class="custom-file-label" for="inputGroupFile01">Choose a .csv file</label>
                </div>
            </div>
        </form>

        <style>
            #chartdiv {
                width: 100%;
                height: 500px;
            }
        </style>
        
        <!-- Resources -->
        <script src="https://www.amcharts.com/lib/4/core.js"></script>
        <script src="https://www.amcharts.com/lib/4/charts.js"></script>
        <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>
        
        <!-- Chart code -->
        <script>
            const fileName = 'aws-costs-file';
            calculateYearly();

            function calculateYearly() {
                const hourlyCommitment=document.getElementById("hourlyCommitment").value || 0.03;
                document.getElementById('yearlyCommitment').innerHTML = Math.round(hourlyCommitment * 24 * 365);
                document.getElementById('monthlyCommitment').innerHTML = Math.round(hourlyCommitment * 24 * 30);
                document.getElementById("calculatedCommitment").style.display = "block";
            }

            function redraw() {
                calculateYearly();
                clear();
                if (localStorage.getItem(fileName)) {
                    const data = calc(localStorage.getItem(fileName).split('\n'));
                    graph(data);
                }
            }

            function clear() {
                if (chart) {
                    chart.dispose();
                }
            }

            // Upload selected file and create array
            function uploadFile(file) {
                calculateYearly();
                clear();
                var reader = new FileReader();
                reader.readAsText(file);
                reader.onload = function(event) {
                    localStorage.setItem(fileName, event.srcElement.result);
                    const lines = localStorage.getItem(fileName).split('\n');
                    const data = calc(lines);
                    graph(data);
                };
            };

            function calc(rows) {
                const services = rows[0].split(',');

                const hourlyCommitment=document.getElementById("hourlyCommitment").value || 0.03;
                const ec2SavingsRate=(document.getElementById("ec2Saving").value || 28)/100;
                const lambdaSavingsRate=(document.getElementById("lambdaSaving").value || 12)/100;

                const ec2_index = services.indexOf("EC2-Instances($)");
                const lambda_index = services.indexOf("Lambda($)");

                const data = [];
                let total = 0;
                for (const row of rows.slice(2)) {
                    const cells = row.split(',');
                    
                    const rowResult = calcRow(cells, hourlyCommitment, ec2_index, lambda_index, ec2SavingsRate, lambdaSavingsRate);
                    total = total + rowResult.ec2 + rowResult.lambda - rowResult.overpay;
                    
                    data.push({
                        'date': cells[0],
                        'value': total
                    });
                }
                return data;
            }

            function calcRow(row, hourlyCommitment, ec2_index, lambda_index, ec2SavingsRate, lambdaSavingsRate) {
                let ec2Spending;
                if (ec2_index != -1) {
                    ec2Spending = (+row[ec2_index])/24;
                } else {
                    ec2Spending = 0;
                }
                
                const rowSaving = {}
                let remainingCommitment;
                if (ec2Spending >= hourlyCommitment) {
                    rowSaving.ec2 = hourlyCommitment * ec2SavingsRate * 24;
                    return {...rowSaving, 'lambda': 0, 'overpay': 0}
                } else {
                    rowSaving.ec2 = ec2Spending * ec2SavingsRate * 24
                    remainingCommitment = hourlyCommitment - ec2Spending;
                }

                let lambdaSpending;
                if (lambda_index != -1) {
                    lambdaSpending = (+row[lambda_index])/24;
                } else {
                    lambdaSpending = 0;
                }
                if (lambdaSpending >= remainingCommitment) {
                    rowSaving.lambda = remainingCommitment * lambdaSavingsRate * 24;
                    return {...rowSaving, 'overpay': 0}
                } else {
                    rowSaving.lambda = lambdaSpending * lambdaSavingsRate * 24;
                    remainingCommitment = remainingCommitment - lambdaSpending;
                }

                return {...rowSaving, 'overpay': remainingCommitment * 24};
            }

            let chart = null;
            function graph(data) {

                // Themes begin
                am4core.useTheme(am4themes_animated);
                // Themes end
                
                // Create chart instance
                chart = am4core.create("chartdiv", am4charts.XYChart);
                chart.paddingRight = 20;
                
                // Add data
                chart.data = data;
                
                // Create axes
                var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
                categoryAxis.dataFields.category = "date";
                categoryAxis.renderer.minGridDistance = 100;
                categoryAxis.renderer.grid.template.location = 0.5;
                categoryAxis.startLocation = 0.5;
                categoryAxis.endLocation = 0.5;
                categoryAxis.renderer.labels.template.fontSize = 15;
                
                // Create value axis
                var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
                valueAxis.baseValue = 0;
                
                // Create series
                var series = chart.series.push(new am4charts.LineSeries());
                series.dataFields.valueY = "value";
                series.dataFields.categoryX = "date";
                series.strokeWidth = 2;
                // series.tensionX = 0.77;
                
                // bullet is added because we add tooltip to a bullet for it to change color
                var bullet = series.bullets.push(new am4charts.Bullet());
                bullet.tooltipText = "{valueY}";
                
                bullet.adapter.add("fill", function(fill, target){
                    if(target.dataItem.valueY < 0){
                        return am4core.color("#FF0000");
                    }
                    return fill;
                })
                var range = valueAxis.createSeriesRange(series);
                range.value = 0;
                range.endValue = -1000;
                range.contents.stroke = am4core.color("#FF0000");
                range.contents.fill = range.contents.stroke;
                
                // Add scrollbar
                var scrollbarX = new am4charts.XYChartScrollbar();
                scrollbarX.series.push(series);
                chart.scrollbarX = scrollbarX;
                
                chart.cursor = new am4charts.XYCursor();
            }
        </script>
        
        <!-- HTML -->
        <div id="chartdiv"></div>